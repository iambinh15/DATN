<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh toán - CotiT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; color: #111; line-height: 1.6; }
    .header { background: #000; color: #fff; position: sticky; top: 0; z-index: 1000; }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
    .logo { font-size: 28px; font-weight: 700; letter-spacing: 3px; text-decoration: none; color: #fff; }
    .secure-text { display: flex; align-items: center; gap: 8px; color: #999; font-size: 13px; }
    .page-header { background: #fff; border-bottom: 1px solid #eee; padding: 30px 20px; }
    .page-header-content { max-width: 1000px; margin: 0 auto; }
    .page-title { font-size: 28px; font-weight: 400; letter-spacing: 2px; }
    .checkout-layout { max-width: 1000px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 380px; gap: 40px; }
    .checkout-section { background: #fff; border-radius: 12px; padding: 30px; margin-bottom: 25px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
    .section-title .number { width: 28px; height: 28px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; }
    .address-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .address-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .address-option.active { border-color: #000; background: #fafafa; }
    .address-option input[type="radio"] { display: none; }
    .radio-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .address-option.active .radio-circle { border-color: #000; }
    .radio-circle::after { content: ''; width: 10px; height: 10px; background: #000; border-radius: 50%; opacity: 0; }
    .address-option.active .radio-circle::after { opacity: 1; }
    .form-select, .form-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
    .new-address-form { display: none; margin-top: 20px; }
    .new-address-form.active { display: block; }
    .confirmed-address { display: none; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #000; }
    .confirmed-address.active { display: block; }
    .payment-methods { display: flex; gap: 15px; }
    .payment-option { flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 20px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; }
    .payment-option.active { border-color: #000; background: #fafafa; }
    .order-summary { background: #fff; border-radius: 12px; padding: 30px; position: sticky; top: 100px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .summary-row.total { border-top: 2px solid #000; padding-top: 20px; font-size: 20px; font-weight: 700; }
    .btn-checkout { width: 100%; padding: 18px; background: #000; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 25px; }
  </style>
</head>
<body>
<header class="header">
  <nav class="nav-container">
    <a th:href="@{/khach-hang/trang-chu}" class="logo">COTIT</a>
    <div class="secure-text"><i class="fas fa-lock"></i> Thanh toán bảo mật</div>
  </nav>
</header>

<div class="checkout-layout">
  <div class="checkout-main">
    <div class="checkout-section">
      <h2 class="section-title"><span class="number">1</span> Địa chỉ giao hàng</h2>
      <div class="address-options">
        <label class="address-option active" id="optionTK" onclick="chonDiaChiTK()">
          <input type="radio" name="dc" checked>
          <div class="radio-circle"></div>
          <span class="option-text">Địa chỉ theo tài khoản</span>
        </label>
        <label class="address-option" id="optionMoi" onclick="chonDiaChiMoi()">
          <input type="radio" name="dc">
          <div class="radio-circle"></div>
          <span class="option-text">Nhập địa chỉ mới</span>
        </label>
      </div>

      <div id="diaChiTK" class="address-select-box">
        <select id="diaChiMacDinh" class="form-select" onchange="capNhatDiaChiTuDanhSach()">
          <option value="">-- Chọn địa chỉ đã lưu --</option>
          <option th:each="dc : ${dsDiaChi}" th:value="${dc.diaChi}" th:text="${dc.diaChi}"></option>
        </select>
      </div>

      <div id="diaChiMoi" class="new-address-form">
        <input id="soNha" class="form-input" placeholder="Số nhà, tên đường...">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
          <select id="tinh" class="form-select"><option>-- Tỉnh/TP --</option></select>
          <select id="huyen" class="form-select"><option>-- Quận/Huyện --</option></select>
          <select id="xa" class="form-select"><option>-- Phường/Xã --</option></select>
        </div>
        <button type="button" class="btn-checkout" style="margin-top: 0;" onclick="xacNhanDiaChiMoi()">Xác nhận địa chỉ này</button>
      </div>

      <div id="diaChiXacNhan" class="confirmed-address">
        <p style="font-size: 12px; color: #666;">GIAO ĐẾN:</p>
        <p id="labelDiaChi" style="font-weight: 600;"></p>
      </div>
    </div>

    <div class="checkout-section">
      <h2 class="section-title"><span class="number">2</span> Thanh toán</h2>
      <div class="payment-methods">
        <label class="payment-option active" onclick="selectPayment(this, 'COD')">
          <input type="radio" name="pay" value="COD" checked><span>Tiền mặt (COD)</span>
        </label>
        <label class="payment-option" onclick="selectPayment(this, 'VNPAY')">
          <input type="radio" name="pay" value="VNPAY"><span>VNPay</span>
        </label>
      </div>
    </div>
  </div>

  <div class="order-summary">
    <h3 style="margin-bottom: 20px;">ĐƠN HÀNG</h3>
    <div class="summary-row"><span>Tiền hàng</span><span th:text="|${#numbers.formatDecimal(tongTienHang,0,'COMMA',0,'POINT')} đ|"></span></div>
    <div class="summary-row"><span>Phí vận chuyển</span><span id="ship">0 đ</span></div>
    <div class="summary-row total"><span>Tổng cộng</span><span id="tong">0 đ</span></div>
    <button class="btn-checkout" onclick="thanhToan()">ĐẶT HÀNG NGAY</button>
  </div>
</div>

<script th:inline="javascript">
  const TOKEN = "0159688c-fb78-11f0-92cb-eef4825ef61b";
  const SHOP_DISTRICT = 1488; // Thay bằng DistrictID của shop bạn nếu cần
  const tienHang = /*[[${tongTienHang}]]*/ 0;
  let phiShip = 0;
  let diaChiFinal = "";

  document.addEventListener('DOMContentLoaded', () => { capNhatTien(); loadProvinces(); });

  async function loadProvinces() {
    const r = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", { headers: { Token: TOKEN } });
    const d = await r.json();
    d.data.forEach(p => tinh.innerHTML += `<option value="${p.ProvinceID}">${p.ProvinceName}</option>`);
  }

  tinh.onchange = async () => {
    const r = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/district?province_id=${tinh.value}`, { headers: { Token: TOKEN } });
    const d = await r.json();
    huyen.innerHTML = "<option>-- Quận/Huyện --</option>";
    d.data.forEach(x => huyen.innerHTML += `<option value="${x.DistrictID}">${x.DistrictName}</option>`);
  };

  huyen.onchange = async () => {
    const r = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=${huyen.value}`, { headers: { Token: TOKEN } });
    const d = await r.json();
    xa.innerHTML = "<option>-- Phường/Xã --</option>";
    d.data.forEach(x => xa.innerHTML += `<option value="${x.WardCode}">${x.WardName}</option>`);
  };

  function chonDiaChiMoi() {
    document.getElementById('diaChiMoi').classList.add('active');
    document.getElementById('diaChiTK').style.display = 'none';
    document.getElementById('optionTK').classList.remove('active');
    document.getElementById('optionMoi').classList.add('active');
    phiShip = 0; capNhatTien();
  }

  function chonDiaChiTK() {
    document.getElementById('diaChiMoi').classList.remove('active');
    document.getElementById('diaChiTK').style.display = 'block';
    document.getElementById('optionTK').classList.add('active');
    document.getElementById('optionMoi').classList.remove('active');
    capNhatDiaChiTuDanhSach();
  }

  async function capNhatDiaChiTuDanhSach() {
    const val = document.getElementById('diaChiMacDinh').value;
    if (!val) return;
    diaChiFinal = val;
    document.getElementById('labelDiaChi').innerText = diaChiFinal;
    document.getElementById('diaChiXacNhan').classList.add('active');
    document.getElementById('ship').innerText = "Đang tính phí...";

    const parts = val.split(',').map(p => p.trim());
    const tTinh = parts[parts.length - 1], tHuyen = parts[parts.length - 2], tXa = parts[parts.length - 3];

    try {
      const resP = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", { headers: { Token: TOKEN } });
      const provinces = (await resP.json()).data;
      const pObj = provinces.find(p => tTinh.includes(p.ProvinceName) || p.ProvinceName.includes(tTinh));

      const resD = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/district?province_id=${pObj.ProvinceID}`, { headers: { Token: TOKEN } });
      const districts = (await resD.json()).data;
      const dObj = districts.find(d => tHuyen.includes(d.DistrictName) || d.DistrictName.includes(tHuyen));

      const resW = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=${dObj.DistrictID}`, { headers: { Token: TOKEN } });
      const wards = (await resW.json()).data;
      const wObj = wards.find(w => tXa.includes(w.WardName) || w.WardName.includes(tXa));

      goiApiTinhPhi(dObj.DistrictID, wObj.WardCode);
    } catch (e) { document.getElementById('ship').innerText = "Không tính được phí ship"; }
  }

  function xacNhanDiaChiMoi() {
    diaChiFinal = `${soNha.value}, ${xa.options[xa.selectedIndex].text}, ${huyen.options[huyen.selectedIndex].text}, ${tinh.options[tinh.selectedIndex].text}`;
    document.getElementById('labelDiaChi').innerText = diaChiFinal;
    document.getElementById('diaChiXacNhan').classList.add('active');
    goiApiTinhPhi(huyen.value, xa.value);
  }

  function goiApiTinhPhi(dID, wCode) {
    fetch("/khach-hang/tinh-phi-ship-dia-chi-moi", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ districtId: dID, wardCode: wCode })
    }).then(r => r.json()).then(d => { phiShip = d.phiShip; capNhatTien(); });
  }

  function capNhatTien() {
    document.getElementById('ship').innerText = phiShip.toLocaleString() + " đ";
    document.getElementById('tong').innerText = (tienHang + phiShip).toLocaleString() + " đ";
  }

  function selectPayment(el, v) {
    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    el.querySelector('input').checked = true;
  }

  function thanhToan() {
    if (!diaChiFinal) { alert("Vui lòng chọn địa chỉ!"); return; }
    fetch("/khach-hang/luu-dia-chi-tam", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ diaChi: diaChiFinal, phiShip: phiShip })
    }).then(() => {
      const p = document.querySelector("input[name='pay']:checked").value;
      if (p === "VNPAY") location.href = "/api/vnpay/pay?amount=" + (tienHang + phiShip);
      else { alert("Thành công!"); location.href = "/khach-hang/trang-chu"; }
    });
  }
</script>
</body>
</html>