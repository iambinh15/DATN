<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh toán - CotiT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; color: #111; line-height: 1.6; }
    .header { background: #000; color: #fff; position: sticky; top: 0; z-index: 1000; }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
    .logo { font-size: 28px; font-weight: 700; letter-spacing: 3px; text-decoration: none; color: #fff; }
    .checkout-layout { max-width: 1000px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 380px; gap: 40px; }
    .checkout-section { background: #fff; border-radius: 12px; padding: 30px; margin-bottom: 25px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
    .section-title .number { width: 28px; height: 28px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; }
    .address-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; margin-bottom: 12px; }
    .address-option.active { border-color: #000; background: #fafafa; }
    .address-option input { display: none; }
    .radio-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .address-option.active .radio-circle { border-color: #000; }
    .radio-circle::after { content: ''; width: 10px; height: 10px; background: #000; border-radius: 50%; opacity: 0; }
    .address-option.active .radio-circle::after { opacity: 1; }
    .form-select, .form-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
    .new-address-form { display: none; margin-top: 20px; }
    .new-address-form.active { display: block; }
    .confirmed-address { display: none; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #000; }
    .confirmed-address.active { display: block; }
    .payment-option { display: flex; align-items: center; gap: 10px; padding: 20px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
    .payment-option.active { border-color: #000; background: #fafafa; }
    .order-summary { background: #fff; border-radius: 12px; padding: 30px; position: sticky; top: 100px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .summary-row.total { border-top: 2px solid #000; padding-top: 20px; font-size: 20px; font-weight: 700; }
    .btn-checkout { width: 100%; padding: 18px; background: #000; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 25px; }

    /* VOUCHER STYLES */
    .voucher-scroll-container { max-height: 200px; overflow-y: auto; border: 1px solid #f0f0f0; border-radius: 8px; padding: 5px; margin-top: 10px; }
    .voucher-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; position: relative; background: #fff; transition: 0.3s; }
    .voucher-item.disabled { opacity: 0.5; background: #f9f9f9; cursor: not-allowed; }
    .voucher-item.active { border-color: #000; background: #fcfcfc; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .btn-apply-v { padding: 6px 12px; font-size: 11px; border: 1px solid #000; background: #fff; cursor: pointer; border-radius: 4px; font-weight: 600; }
    .btn-apply-v.selected { background: #000; color: #fff; }
  </style>
</head>

<body>
<header class="header">
  <nav class="nav-container"><a th:href="@{/khach-hang/trang-chu}" class="logo">COTIT</a></nav>
</header>

<div class="checkout-layout">
  <div class="checkout-main">
    <div class="checkout-section">
      <h2 class="section-title"><span class="number">1</span> Địa chỉ giao hàng</h2>
      <div class="address-options">
        <label class="address-option active" id="optionTK" onclick="chonDiaChiTK()">
          <input type="radio" name="dc" checked><div class="radio-circle"></div><span>Địa chỉ có sẵn</span>
        </label>
        <label class="address-option" id="optionMoi" onclick="chonDiaChiMoi()">
          <input type="radio" name="dc"><div class="radio-circle"></div><span>Địa chỉ mới</span>
        </label>
      </div>

      <div id="diaChiTK">
        <select id="diaChiMacDinh" class="form-select" onchange="capNhatDiaChiTuDanhSach()">
          <option value="">-- Chọn địa chỉ đã lưu --</option>
          <option th:each="dc : ${dsDiaChi}" th:value="${dc.diaChi}" th:text="${dc.diaChi}"></option>
        </select>
      </div>

      <div id="diaChiMoi" class="new-address-form">
        <input id="soNha" class="form-input" placeholder="Số nhà, tên đường...">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
          <select id="tinh" class="form-select"><option value="">-- Tỉnh --</option></select>
          <select id="huyen" class="form-select"><option value="">-- Huyện --</option></select>
          <select id="xa" class="form-select"><option value="">-- Xã --</option></select>
        </div>
        <button type="button" class="btn-checkout" style="margin-top:10px; background:#444" onclick="xacNhanDiaChiMoi()">Xác nhận địa chỉ mới</button>
      </div>

      <div id="diaChiXacNhan" class="confirmed-address">
        <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Giao đến:</p>
        <p id="labelDiaChi" style="font-weight: 600; color: #000;"></p>
      </div>
    </div>

    <div class="checkout-section">
      <h2 class="section-title"><span class="number">2</span> Phương thức thanh toán</h2>
      <div class="payment-methods">
        <label class="payment-option active" onclick="selectPayment(this, 'COD')">
          <input type="radio" name="pay" value="COD" checked>
          <i class="fas fa-truck" style="margin-right: 10px;"></i>
          <span>Thanh toán khi nhận hàng (COD)</span>
        </label>
        <label class="payment-option" onclick="selectPayment(this, 'VNPAY')">
          <input type="radio" name="pay" value="VNPAY">
          <i class="fas fa-credit-card" style="margin-right: 10px;"></i>
          <span>Thanh toán qua VNPay</span>
        </label>
      </div>
    </div>
  </div>

  <div class="order-summary">
    <h3 style="margin-bottom: 20px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px;">ĐƠN HÀNG</h3>

    <label style="font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase;">Mã giảm giá khả dụng</label>
    <div class="voucher-scroll-container">
      <div th:each="km : ${dsMaGiamGia}"
           th:classappend="${tongTienHang < km.giamToiThieu} ? 'voucher-item disabled' : 'voucher-item'"
           th:id="'v-' + ${km.ma}">
        <div style="flex: 1;">
          <b style="font-size: 14px;" th:text="${km.ma}"></b><br>
          <small style="color: #666;" th:text="${km.loaiGiam == 1 ? 'Giảm ' + km.giaTri + '%' : 'Giảm ' + #numbers.formatDecimal(km.giaTri,0,'COMMA',0,'POINT') + 'đ'}"></small>
          <div th:if="${tongTienHang < km.giamToiThieu}" style="font-size: 10px; color: #e74c3c;">
            Thiếu [[${#numbers.formatDecimal(km.giamToiThieu - tongTienHang,0,'COMMA',0,'POINT')}]]đ để dùng
          </div>
        </div>
        <button class="btn-apply-v"
                th:disabled="${tongTienHang < km.giamToiThieu}"
                th:onclick="apDungVoucher([[${km.ma}]], [[${km.loaiGiam}]], [[${km.giaTri}]], [[${km.giamToiDa}]])">Chọn</button>
      </div>
    </div>

    <div style="margin-top: 25px; border-top: 1px dashed #eee; padding-top: 15px;">
      <div class="summary-row">
        <span style="color: #666;">Tiền hàng</span>
        <span th:text="|${#numbers.formatDecimal(tongTienHang,0,'COMMA',0,'POINT')} đ|"></span>
      </div>
      <div class="summary-row" id="rowGiamGia" style="display: none; color: #e74c3c;">
        <span>Mã giảm giá</span>
        <span id="labelGiamGia">-0 đ</span>
      </div>
      <div class="summary-row">
        <span style="color: #666;">Phí vận chuyển</span>
        <span id="ship">0 đ</span>
      </div>
      <div class="summary-row total">
        <span>Tổng cộng</span>
        <span id="tong" style="color: #000;">0 đ</span>
      </div>
    </div>

    <button class="btn-checkout" id="btnMainSubmit" onclick="thanhToan()">ĐẶT HÀNG NGAY</button>
  </div>
</div>

<script th:inline="javascript">
  const TOKEN = "0159688c-fb78-11f0-92cb-eef4825ef61b";
  const tienHang = /*[[${tongTienHang}]]*/ 0;
  let phiShip = 0, tienGiam = 0, maVoucherChon = "", diaChiFinal = "";

  document.addEventListener('DOMContentLoaded', () => {
    capNhatTien();
    loadProvinces();
  });

  // ==========================================
  // 1. XỬ LÝ VOUCHER (ĐÃ FIX LỖI NULL)
  // ==========================================
  function apDungVoucher(ma, loai, giaTri, maxGiam) {
    // Logic toggle chọn/bỏ chọn
    if (maVoucherChon === ma) {
      maVoucherChon = "";
      tienGiam = 0;
    } else {
      maVoucherChon = ma;
      // 0: Tiền mặt, 1: Phần trăm
      tienGiam = (loai === 1) ? Math.min(tienHang * (giaTri / 100), maxGiam || Infinity) : Math.min(giaTri, tienHang);
    }

    // GỬI LÊN SERVER NGAY ĐỂ LƯU SESSION
    fetch('/khach-hang/ap-dung-voucher-session?maVoucher=' + encodeURIComponent(maVoucherChon), {
      method: 'POST'
    })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                console.log("Hệ thống đã nhận voucher: " + maVoucherChon);
                updateVoucherUI();
                capNhatTien();
              } else {
                alert("Voucher không khả dụng: " + data.message);
                maVoucherChon = ""; tienGiam = 0;
                updateVoucherUI(); capNhatTien();
              }
            })
            .catch(err => console.error("Lỗi đồng bộ voucher!", err));
  }

  function updateVoucherUI() {
    document.querySelectorAll('.voucher-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.btn-apply-v').forEach(btn => {
      btn.innerText = "Chọn";
      btn.classList.remove('selected');
    });

    if (maVoucherChon) {
      const item = document.getElementById('v-' + maVoucherChon);
      if (item) {
        item.classList.add('active');
        const btn = item.querySelector('.btn-apply-v');
        btn.innerText = "Đã chọn";
        btn.classList.add('selected');
      }
      document.getElementById('rowGiamGia').style.display = 'flex';
      document.getElementById('labelGiamGia').innerText = "-" + Math.round(tienGiam).toLocaleString() + " đ";
    } else {
      document.getElementById('rowGiamGia').style.display = 'none';
    }
  }

  // ==========================================
  // 2. XỬ LÝ ĐỊA CHỈ & GHN (GIỮ LOGIC CŨ)
  // ==========================================
  async function loadProvinces() {
    const r = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", { headers: { Token: TOKEN } });
    const d = await r.json();
    const tinhSelect = document.getElementById('tinh');
    d.data.forEach(p => tinhSelect.innerHTML += `<option value="${p.ProvinceID}">${p.ProvinceName}</option>`);
  }

  tinh.onchange = async () => {
    const r = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/district?province_id=${tinh.value}`, { headers: { Token: TOKEN } });
    const d = await r.json();
    huyen.innerHTML = "<option value=''>-- Huyện --</option>";
    d.data.forEach(x => huyen.innerHTML += `<option value="${x.DistrictID}">${x.DistrictName}</option>`);
  };

  huyen.onchange = async () => {
    const r = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=${huyen.value}`, { headers: { Token: TOKEN } });
    const d = await r.json();
    xa.innerHTML = "<option value=''>-- Xã --</option>";
    d.data.forEach(x => xa.innerHTML += `<option value="${x.WardCode}">${x.WardName}</option>`);
  };

  function chonDiaChiMoi() {
    document.getElementById('diaChiMoi').classList.add('active');
    document.getElementById('diaChiTK').style.display = 'none';
    document.getElementById('optionTK').classList.remove('active');
    document.getElementById('optionMoi').classList.add('active');
    diaChiFinal = "";
    document.getElementById('diaChiXacNhan').classList.remove('active');
  }

  function chonDiaChiTK() {
    document.getElementById('diaChiMoi').classList.remove('active');
    document.getElementById('diaChiTK').style.display = 'block';
    document.getElementById('optionTK').classList.add('active');
    document.getElementById('optionMoi').classList.remove('active');
    capNhatDiaChiTuDanhSach();
  }

  async function capNhatDiaChiTuDanhSach() {
    const val = document.getElementById('diaChiMacDinh').value;
    if (!val) { diaChiFinal = ""; return; }
    diaChiFinal = val;
    document.getElementById('labelDiaChi').innerText = val;
    document.getElementById('diaChiXacNhan').classList.add('active');

    // Tự động tìm District/Ward để tính ship từ chuỗi địa chỉ
    const p = val.split(',').map(s => s.trim());
    try {
      const resP = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", { headers: { Token: TOKEN } });
      const pObj = (await resP.json()).data.find(x => p[p.length-1].includes(x.ProvinceName));
      const resD = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/district?province_id=${pObj.ProvinceID}`, { headers: { Token: TOKEN } });
      const dObj = (await resD.json()).data.find(x => p[p.length-2].includes(x.DistrictName));
      const resW = await fetch(`https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?district_id=${dObj.DistrictID}`, { headers: { Token: TOKEN } });
      const wObj = (await resW.json()).data.find(x => p[p.length-3].includes(x.WardName));
      goiApiTinhPhi(dObj.DistrictID, wObj.WardCode);
    } catch (e) { console.warn("Không tự động tính được phí ship từ địa chỉ cũ."); }
  }

  function xacNhanDiaChiMoi() {
    if(!soNha.value || !tinh.value || !huyen.value || !xa.value) { alert("Vui lòng nhập đầy đủ thông tin địa chỉ mới!"); return; }
    diaChiFinal = `${soNha.value}, ${xa.options[xa.selectedIndex].text}, ${huyen.options[huyen.selectedIndex].text}, ${tinh.options[tinh.selectedIndex].text}`;
    document.getElementById('labelDiaChi').innerText = diaChiFinal;
    document.getElementById('diaChiXacNhan').classList.add('active');
    goiApiTinhPhi(huyen.value, xa.value);
  }

  function goiApiTinhPhi(dID, wCode) {
    fetch("/khach-hang/tinh-phi-ship-dia-chi-moi", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ districtId: dID, wardCode: wCode })
    }).then(r => r.json()).then(d => {
      phiShip = d.phiShip;
      capNhatTien();
    });
  }

  function capNhatTien() {
    const total = (tienHang - tienGiam) + phiShip;
    document.getElementById('ship').innerText = Math.round(phiShip).toLocaleString() + " đ";
    document.getElementById('tong').innerText = Math.round(total).toLocaleString() + " đ";
  }

  function selectPayment(el, v) {
    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    el.querySelector('input').checked = true;
  }

  // ==========================================
  // 3. XỬ LÝ ĐẶT HÀNG (KẾT HỢP TẤT CẢ)
  // ==========================================
  function thanhToan() {
    if (!diaChiFinal) { alert("Vui lòng chọn hoặc nhập địa chỉ giao hàng!"); return; }

    const btn = document.getElementById('btnMainSubmit');
    btn.disabled = true; btn.innerText = "ĐANG XỬ LÝ...";

    const paymentMethod = document.querySelector("input[name='pay']:checked").value;
    const totalFinal = (tienHang - tienGiam) + phiShip;

    // Bước 1: Lưu thông tin địa chỉ/ship vào Session
    fetch("/khach-hang/luu-dia-chi-tam", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        diaChi: diaChiFinal,
        phiShip: phiShip,
        maVoucher: maVoucherChon,
        tongTien: totalFinal
      })
    }).then(r => {
      if (!r.ok) throw new Error("Lỗi lưu Session");

      // Bước 2: Gọi tạo đơn theo phương thức
      if (paymentMethod === "VNPAY") {
        window.location.href = "/api/vnpay/pay?amount=" + Math.round(totalFinal);
      } else {
        // Gọi tao-don-cod đã có ở Controller
        fetch("/khach-hang/tao-don-cod", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                  if(data.success) {
                    window.location.href = "/khach-hang/payment-success-cod";
                  } else {
                    alert("Đặt hàng thất bại: " + data.message);
                    btn.disabled = false; btn.innerText = "ĐẶT HÀNG NGAY";
                  }
                });
      }
    }).catch(err => {
      alert("Hệ thống lỗi, vui lòng thử lại sau!");
      btn.disabled = false; btn.innerText = "ĐẶT HÀNG NGAY";
    });
  }
</script>
</body>
</html>