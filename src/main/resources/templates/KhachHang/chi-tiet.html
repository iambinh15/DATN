<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${sp != null ? sp.tenSanPham + ' - CotiT' : 'Chi tiết sản phẩm - CotiT'}">Chi tiết sản phẩm - CotiT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* GIỮ NGUYÊN CSS CƠ BẢN CỦA BẠN */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #fff; color: #111; line-height: 1.6; }
        .header { background: #000; color: #fff; position: sticky; top: 0; z-index: 1000; }
        .top-bar { background: #111; text-align: center; padding: 8px; font-size: 12px; letter-spacing: 1px; }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo { font-size: 28px; font-weight: 700; letter-spacing: 3px; text-decoration: none; color: #fff; }
        .nav-menu { display: flex; gap: 40px; list-style: none; }
        .nav-menu a { color: #fff; text-decoration: none; font-size: 13px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; transition: opacity 0.3s; }
        .nav-icons { display: flex; gap: 25px; align-items: center; }
        .nav-icons a { color: #fff; font-size: 18px; }
        .cart-icon { position: relative; }
        .cart-badge { position: absolute; top: -8px; right: -8px; background: #fff; color: #000; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }

        /* DROPDOWN USER */
        .user-dropdown { position: relative; }
        .user-trigger { display: flex; align-items: center; gap: 8px; color: #fff; text-decoration: none; font-size: 13px; cursor: pointer; }
        .user-menu { display: none; position: absolute; top: 100%; right: 0; margin-top: 15px; background: #fff; min-width: 180px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); z-index: 1001; }
        .user-menu.active { display: block; }
        .user-menu a, .user-menu .logout-btn { display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #333; text-decoration: none; font-size: 13px; border: none; background: none; width: 100%; cursor: pointer; }

        .breadcrumb { max-width: 1400px; margin: 0 auto; padding: 20px; font-size: 13px; color: #666; }
        .product-detail { max-width: 1400px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; }
        .main-image { width: 100%; height: 600px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border-radius: 12px; margin-bottom: 20px; }
        .main-image i { font-size: 120px; color: #ddd; }

        .product-info { padding-top: 20px; }
        .product-badge { display: inline-block; background: #000; color: #fff; padding: 5px 15px; font-size: 11px; font-weight: 600; letter-spacing: 1px; margin-bottom: 20px; }
        .product-title { font-size: 32px; font-weight: 400; letter-spacing: 1px; margin-bottom: 10px; }
        .product-price { font-size: 28px; font-weight: 600; margin-bottom: 30px; color: #000; }

        /* ===== NÂNG CẤP PHẦN CHỌN BIẾN THỂ ===== */
        .variant-section { margin-bottom: 30px; }
        .variant-label { font-size: 13px; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; color: #444; }

        .variant-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }

        .variant-item { position: relative; }

        .variant-item input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }

        .variant-card {
            display: flex; flex-direction: column; padding: 12px; border: 2px solid #eee;
            border-radius: 10px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center; background: #fff;
        }

        .variant-card:hover { border-color: #999; }

        .variant-item input[type="radio"]:checked + .variant-card {
            border-color: #000; background-color: #fcfcfc; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .variant-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #111; }
        .variant-stock-info { font-size: 11px; color: #888; }

        /* Trạng thái hết hàng cho card */
        .variant-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .variant-item.disabled .variant-card { background: #f9f9f9; border-style: dashed; }
        .variant-item.disabled .variant-name { text-decoration: line-through; }

        /* BUTTONS */
        .btn-add-cart { width: 100%; padding: 18px 30px; background: #000; color: #fff; border: 2px solid #000; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; border-radius: 4px; }
        .btn-add-cart:hover:not(:disabled) { background: #fff; color: #000; }
        .btn-add-cart:disabled { background: #ccc; border-color: #ccc; cursor: not-allowed; }

        .footer { background: #000; color: #fff; padding: 60px 20px 30px; margin-top: 80px; }
    </style>
</head>

<body>

<header class="header">
    <div class="top-bar">MIỄN PHÍ VẬN CHUYỂN CHO ĐƠN HÀNG TỪ 500K</div>
    <nav class="nav-container">
        <a th:href="@{/khach-hang/trang-chu}" class="logo">COTIT</a>
        <ul class="nav-menu">
            <li><a th:href="@{/khach-hang/trang-chu}">Trang chủ</a></li>
            <li><a href="#">Sản phẩm</a></li>
            <li><a href="#">Bộ sưu tập</a></li>
        </ul>
        <div class="nav-icons">
            <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-dropdown">
                <a class="user-trigger" onclick="toggleUserMenu(event)">
                    <i class="fas fa-user"></i>
                    <span class="user-name" th:text="${session.tenKhachHang != null ? session.tenKhachHang : #authentication.name}">User</span>
                </a>
                <div class="user-menu" id="userMenu">
                    <a href="#"><i class="fas fa-user-circle"></i> Tài khoản</a>
                    <a th:href="@{/khach-hang/don-hang}"><i class="fas fa-box"></i> Đơn hàng</a>
                    <form th:action="@{/logout}" method="post"><button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button></form>
                </div>
            </div>
            <a th:href="@{/khach-hang/gio-hang}" class="cart-icon"><i class="fas fa-shopping-bag"></i><span class="cart-badge">0</span></a>
        </div>
    </nav>
</header>

<div class="breadcrumb">
    <a th:href="@{/khach-hang/trang-chu}">Trang chủ</a> <span>/</span> Sản phẩm <span>/</span> <span th:text="${sp.tenSanPham}"></span>
</div>

<div th:if="${sp != null}" class="product-detail">
    <div class="product-gallery">
        <div class="main-image"><i class="fas fa-tshirt"></i></div>
    </div>

    <div class="product-info">
        <span class="product-badge">NEW ARRIVAL</span>
        <h1 class="product-title" th:text="${sp.tenSanPham}"></h1>
        <p class="product-price" id="priceDisplay">Vui lòng chọn size/màu</p>

        <form th:action="@{/khach-hang/gio-hang/add}" method="post" id="cartForm">
            <div class="variant-section">
                <p class="variant-label">Phiên bản sẵn có</p>
                <div class="variant-grid">
                    <label th:each="bt : ${listBienThe}" class="variant-item" th:classappend="${bt.soLuong <= 0} ? 'disabled'">
                        <input type="radio" name="productId"
                               th:value="${bt.id}"
                               th:disabled="${bt.soLuong <= 0}"
                               th:data-price="${bt.donGia}"
                               th:data-stock="${bt.soLuong}"
                               onchange="updateUI(this)" required>
                        <div class="variant-card">
                            <span class="variant-name" th:text="${(bt.idMauSac != null ? bt.idMauSac.tenMau : 'N/A') + ' / ' + (bt.idSize != null ? bt.idSize.tenSize : 'N/A')}"></span>
                            <span class="variant-stock-info" th:text="${bt.soLuong > 0 ? 'Còn ' + bt.soLuong : 'Hết hàng'}"></span>
                        </div>
                    </label>
                </div>
            </div>

            <button type="submit" class="btn-add-cart" id="addToCartBtn" disabled>
                <i class="fas fa-shopping-bag"></i> <span id="btnText">CHỌN PHIÊN BẢN</span>
            </button>
        </form>

        <a th:href="@{/khach-hang/gio-hang}" class="btn-buy-now">XEM GIỎ HÀNG</a>
    </div>
</div>

<script>
    function toggleUserMenu(e) {
        e.preventDefault();
        document.getElementById('userMenu').classList.toggle('active');
    }

    function updateUI(radio) {
        const priceDisplay = document.getElementById('priceDisplay');
        const btn = document.getElementById('addToCartBtn');
        const btnText = document.getElementById('btnText');

        const price = parseFloat(radio.getAttribute('data-price'));
        const stock = parseInt(radio.getAttribute('data-stock'));

        // Cập nhật giá tiền sinh động
        priceDisplay.textContent = price.toLocaleString('vi-VN') + ' VNĐ';
        priceDisplay.style.color = "#000";

        // Mở khóa nút bấm
        btn.disabled = false;
        btnText.textContent = "THÊM VÀO GIỎ HÀNG";
    }

    // Đóng menu khi click ra ngoài
    document.addEventListener('click', function (e) {
        const dropdown = document.querySelector('.user-dropdown');
        if (dropdown && !dropdown.contains(e.target)) {
            document.getElementById('userMenu').classList.remove('active');
        }
    });
</script>
</body>
</html>