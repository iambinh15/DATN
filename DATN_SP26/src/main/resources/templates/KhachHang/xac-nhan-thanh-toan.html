<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Xác nhận đơn hàng - DATN SP26</title>
  <style>
    body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .checkout-box {
      max-width: 500px; margin: 50px auto; padding: 30px;
      background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #333; margin-bottom: 25px; }
    .row { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 16px; }
    .total-row { border-top: 2px dashed #eee; padding-top: 20px; font-size: 20px; font-weight: bold; color: #d32f2f; }
    .payment-option {
      display: flex; align-items: center; padding: 12px; border: 1px solid #ddd;
      border-radius: 8px; margin-bottom: 10px; cursor: pointer;
    }
    .payment-option input { margin-right: 15px; }
    .btn-confirm {
      width: 100%; padding: 16px; background: #f37021; color: white;
      border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;
    }
    .error-msg { color: #d32f2f; font-size: 13px; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>

<div class="checkout-box">
  <h2>XÁC NHẬN ĐƠN HÀNG</h2>

  <div class="row">
    <span>Tiền hàng:</span>
    <b id="labelTienHang" th:text="|${#numbers.formatDecimal(tongTienHang, 0, 'COMMA', 0, 'POINT')} đ|">0 đ</b>
  </div>

  <div class="row">
    <span>Phí giao hàng (GHN):</span>
    <b id="shipFee" style="color: #27ae60;">Đang tính...</b>
  </div>

  <div class="row total-row">
    <span>Tổng thanh toán:</span>
    <span id="finalTotal">---</span>
  </div>

  <div class="payment-methods">
    <p style="font-weight: bold;">Chọn phương thức thanh toán:</p>
    <div class="payment-option">
      <input type="radio" id="payCOD" name="paymentMethod" value="COD" checked>
      <label for="payCOD">Thanh toán tiền mặt (COD)</label>
    </div>
    <div class="payment-option">
      <input type="radio" id="payVNPay" name="paymentMethod" value="VNPAY">
      <label for="payVNPay">Thanh toán Online qua VNPay</label>
    </div>
  </div>

  <div id="errorArea" class="error-msg"></div>
  <button class="btn-confirm" onclick="xuLyThanhToan()">XÁC NHẬN ĐẶT HÀNG</button>
</div>

<script th:inline="javascript">
  let currentTongThanhToan = 0;

  (function() {
    try {
      const dataGHNRaw = /*[[${dataGHN}]]*/ '{}';
      const tienHang = /*[[${tongTienHang}]]*/ 0;
      const resGHN = (typeof dataGHNRaw === 'string') ? JSON.parse(dataGHNRaw) : dataGHNRaw;

      const shipFeeElem = document.getElementById('shipFee');
      const finalTotalElem = document.getElementById('finalTotal');

      if (resGHN && resGHN.code === 200 && resGHN.data) {
        const phiShip = resGHN.data.total;
        currentTongThanhToan = tienHang + phiShip;
        shipFeeElem.innerText = phiShip.toLocaleString('vi-VN') + ' đ';
        finalTotalElem.innerText = currentTongThanhToan.toLocaleString('vi-VN') + ' đ';
      } else {
        currentTongThanhToan = tienHang;
        finalTotalElem.innerText = tienHang.toLocaleString('vi-VN') + ' đ';
        document.getElementById('errorArea').innerText = "Không thể tính phí ship GHN.";
      }
    } catch (e) { console.error(e); }
  })();

  function xuLyThanhToan() {
    const method = document.querySelector('input[name="paymentMethod"]:checked').value;
    // Làm tròn để tránh lỗi định dạng dữ liệu VNPay
    const cleanAmount = Math.floor(currentTongThanhToan);

    if (method === "VNPAY") {
      window.location.href = "/api/vnpay/pay?amount=" + cleanAmount;
    } else {
      window.location.href = "/api/order/create-cod?amount=" + cleanAmount;
    }
  }
</script>
</body>
</html>