<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>X√°c nh·∫≠n ƒë∆°n h√†ng - DATN SP26</title>
  <style>
    body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .checkout-box {
      max-width: 500px; margin: 50px auto; padding: 30px;
      background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #333; margin-bottom: 25px; }
    .row { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 16px; }
    .total-row { border-top: 2px dashed #eee; padding-top: 20px; font-size: 20px; font-weight: bold; color: #d32f2f; }
    .payment-option {
      display: flex; align-items: center; padding: 12px; border: 1px solid #ddd;
      border-radius: 8px; margin-bottom: 10px; cursor: pointer;
    }
    .payment-option input { margin-right: 15px; }
    .btn-confirm {
      width: 100%; padding: 16px; background: #f37021; color: white;
      border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;
    }
    .error-msg { color: #d32f2f; font-size: 13px; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>

<div class="checkout-box">
  <h2>X√ÅC NH·∫¨N ƒê∆†N H√ÄNG</h2>

  <div class="row">
    <span>Ti·ªÅn h√†ng:</span>
    <b id="labelTienHang" th:text="|${#numbers.formatDecimal(tongTienHang, 0, 'COMMA', 0, 'POINT')} ƒë|">0 ƒë</b>
  </div>

  <div class="row">
    <span>Ph√≠ giao h√†ng (GHN):</span>
    <b id="shipFee" style="color: #27ae60;">ƒêang t√≠nh...</b>
  </div>

  <div class="row total-row">
    <span>T·ªïng thanh to√°n:</span>
    <span id="finalTotal">---</span>
  </div>
  <!-- KHUY·∫æN M√ÉI -->
  <div class="promotion-box" style="margin-bottom: 20px;">
    <p style="font-weight: bold;">Ch·ªçn m√£ gi·∫£m gi√°:</p>

    <select id="maGiamGiaSelect" onchange="apDungMaGiamGia()" style="width: 100%; padding: 8px;">
      <option value="0" data-value="0">-- Kh√¥ng d√πng m√£ --</option>

      <option th:each="km : ${dsMaGiamGia}"
              th:value="${km.id}"
              th:data-value="${km.giaTri}"
              th:text="|${km.ma} - Gi·∫£m ${#numbers.formatDecimal(km.giaTri,0,'COMMA',0,'POINT')} ƒë|">
      </option>
    </select>
  </div>

  <div class="payment-methods">
    <p style="font-weight: bold;">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</p>
    <div class="payment-option">
      <input type="radio" id="payCOD" name="paymentMethod" value="COD" checked>
      <label for="payCOD">Thanh to√°n ti·ªÅn m·∫∑t (COD)</label>
    </div>
    <div class="payment-option">
      <input type="radio" id="payVNPay" name="paymentMethod" value="VNPAY">
      <label for="payVNPay">Thanh to√°n Online qua VNPay</label>
    </div>
  </div>

  <div id="errorArea" class="error-msg"></div>
  <button class="btn-confirm" onclick="xuLyThanhToan()">X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG</button>
</div>

<script th:inline="javascript">
  let currentTongThanhToan = 0;
  let phiShip = 0;
  let giamGia = 0;
  const tienHang = /*[[${tongTienHang}]]*/ 0;

  (function() {
    try {
      const dataGHNRaw = /*[[${dataGHN}]]*/ '{}';
      const resGHN = (typeof dataGHNRaw === 'string') ? JSON.parse(dataGHNRaw) : dataGHNRaw;

      const shipFeeElem = document.getElementById('shipFee');
      const finalTotalElem = document.getElementById('finalTotal');

      if (resGHN && resGHN.code === 200 && resGHN.data) {
        phiShip = resGHN.data.total;
        currentTongThanhToan = tienHang + phiShip;
        shipFeeElem.innerText = phiShip.toLocaleString('vi-VN') + ' ƒë';
        finalTotalElem.innerText = currentTongThanhToan.toLocaleString('vi-VN') + ' ƒë';
      }
    } catch (e) { console.error(e); }
  })();

  // ‚úÖ H√ÄM √ÅP D·ª§NG M√É GI·∫¢M GI√Å
  function apDungMaGiamGia() {
    const select = document.getElementById("maGiamGiaSelect");
    const selectedOption = select.options[select.selectedIndex];

    giamGia = parseInt(selectedOption.getAttribute("data-value")) || 0;

    // üî• Gi·∫£m gi√° CH·ªà ti·ªÅn h√†ng
    let tienSauGiam = tienHang - giamGia;
    if (tienSauGiam < 0) tienSauGiam = 0;

    currentTongThanhToan = tienSauGiam + phiShip;

    document.getElementById("finalTotal").innerText =
            currentTongThanhToan.toLocaleString("vi-VN") + " ƒë";
  }
  (function() {
    try {
      const dataGHNRaw = /*[[${dataGHN}]]*/ '{}';
      const tienHang = /*[[${tongTienHang}]]*/ 0;
      const resGHN = (typeof dataGHNRaw === 'string') ? JSON.parse(dataGHNRaw) : dataGHNRaw;

      const shipFeeElem = document.getElementById('shipFee');
      const finalTotalElem = document.getElementById('finalTotal');

      if (resGHN && resGHN.code === 200 && resGHN.data) {
        phiShip = resGHN.data.total; //d√≤ng n√†y ƒë·ªÉ cho ph√≠ ship ra ngo√†i kh√¥ng b·ªã gi√°m gi√°
        currentTongThanhToan = tienHang + phiShip;
        shipFeeElem.innerText = phiShip.toLocaleString('vi-VN') + ' ƒë';
        finalTotalElem.innerText = currentTongThanhToan.toLocaleString('vi-VN') + ' ƒë';
      } else {
        currentTongThanhToan = tienHang;
        finalTotalElem.innerText = tienHang.toLocaleString('vi-VN') + ' ƒë';
        document.getElementById('errorArea').innerText = "Kh√¥ng th·ªÉ t√≠nh ph√≠ ship GHN.";
      }
    } catch (e) { console.error(e); }
  })();

  function xuLyThanhToan() {
    const method = document.querySelector('input[name="paymentMethod"]:checked').value;
    // L√†m tr√≤n ƒë·ªÉ tr√°nh l·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu VNPay
    const cleanAmount = Math.floor(currentTongThanhToan);

    if (method === "VNPAY") {
      window.location.href = "/api/vnpay/pay?amount=" + cleanAmount;
    } else {
      window.location.href = "/api/order/create-cod?amount=" + cleanAmount;
    }
  }
</script>
</body>
</html>